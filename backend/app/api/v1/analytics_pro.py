# @AI-HINT: Advanced analytics API endpoints with ML predictions
"""
Advanced Analytics API - Business intelligence and predictive analytics.

Endpoints for:
- Revenue forecasting
- Cohort analysis
- Churn prediction
- Market trends
- Platform health
"""

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import Optional
from datetime import datetime
from pydantic import BaseModel
import logging

from app.db.session import get_db
from app.core.security import get_current_active_user
from app.models.user import User
from app.services.advanced_analytics import (
    AdvancedAnalyticsService,
    get_advanced_analytics_service
)

logger = logging.getLogger(__name__)

router = APIRouter()


# ============================================================================
# Revenue Analytics
# ============================================================================

@router.get("/revenue/forecast")
async def get_revenue_forecast(
    months_ahead: int = Query(6, ge=1, le=24, description="Months to forecast"),
    include_confidence: bool = Query(True, description="Include confidence intervals"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Get ML-powered revenue forecast.
    
    Uses time series analysis to predict future revenue with confidence intervals.
    Admin only endpoint.
    """
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        service = get_advanced_analytics_service(db)
        
        forecast = await service.get_revenue_forecast(
            months_ahead=months_ahead,
            include_confidence=include_confidence
        )
        
        return forecast
        
    except Exception as e:
        logger.error(f"Revenue forecast error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to generate forecast")


@router.get("/revenue/breakdown")
async def get_revenue_breakdown(
    start_date: Optional[datetime] = Query(None, description="Period start"),
    end_date: Optional[datetime] = Query(None, description="Period end"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Get revenue breakdown by category, type, and source.
    
    Admin only endpoint.
    """
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        service = get_advanced_analytics_service(db)
        
        breakdown = await service.get_revenue_breakdown(
            start_date=start_date,
            end_date=end_date
        )
        
        return breakdown
        
    except Exception as e:
        logger.error(f"Revenue breakdown error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to get breakdown")


# ============================================================================
# User Analytics
# ============================================================================

@router.get("/cohort-analysis")
async def get_cohort_analysis(
    cohort_type: str = Query("monthly", description="Cohort grouping: monthly or weekly"),
    metric: str = Query("retention", description="Metric to analyze"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Perform cohort analysis for user retention.
    
    Tracks how user cohorts behave over time periods.
    Admin only endpoint.
    """
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    if cohort_type not in ["monthly", "weekly"]:
        raise HTTPException(status_code=400, detail="Invalid cohort type")
    
    try:
        service = get_advanced_analytics_service(db)
        
        analysis = await service.get_cohort_analysis(
            cohort_type=cohort_type,
            metric=metric
        )
        
        return analysis
        
    except Exception as e:
        logger.error(f"Cohort analysis error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to get cohort analysis")


@router.get("/churn-prediction")
async def get_churn_predictions(
    user_id: Optional[int] = Query(None, description="Specific user to predict"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Get churn predictions for users.
    
    Uses ML model to predict which users are at risk of churning.
    Admin only endpoint (unless checking own prediction).
    """
    # Allow users to check their own churn risk
    if user_id and user_id != current_user.id and current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    if not user_id and current_user.role != "admin":
        # Non-admins can only see their own prediction
        user_id = current_user.id
    
    try:
        service = get_advanced_analytics_service(db)
        
        predictions = await service.get_churn_prediction(user_id=user_id)
        
        return predictions
        
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))
    except Exception as e:
        logger.error(f"Churn prediction error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to get predictions")


# ============================================================================
# Market Analytics
# ============================================================================

@router.get("/market-trends")
async def get_market_trends(
    category: Optional[str] = Query(None, description="Filter by category"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Get market trends for skills and categories.
    
    Analyzes demand patterns and pricing trends.
    """
    try:
        service = get_advanced_analytics_service(db)
        
        trends = await service.get_market_trends(category=category)
        
        return trends
        
    except Exception as e:
        logger.error(f"Market trends error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to get market trends")


# ============================================================================
# Platform Health
# ============================================================================

@router.get("/platform-health")
async def get_platform_health(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Get comprehensive platform health metrics.
    
    Includes user engagement, activity levels, and conversion rates.
    Admin only endpoint.
    """
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        service = get_advanced_analytics_service(db)
        
        health = await service.get_platform_health()
        
        return health
        
    except Exception as e:
        logger.error(f"Platform health error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to get platform health")


# ============================================================================
# Dashboard Summary
# ============================================================================

@router.get("/dashboard-summary")
async def get_analytics_dashboard(
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Get combined analytics dashboard data.
    
    Returns key metrics for admin dashboard in single request.
    Admin only endpoint.
    """
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        service = get_advanced_analytics_service(db)
        
        # Gather all metrics
        health = await service.get_platform_health()
        revenue = await service.get_revenue_breakdown()
        trends = await service.get_market_trends()
        forecast = await service.get_revenue_forecast(months_ahead=3)
        
        return {
            "platform_health": health,
            "revenue_summary": {
                "current_period": revenue["total_revenue"],
                "transaction_count": revenue["transaction_count"],
                "top_category": revenue["by_category"][0] if revenue["by_category"] else None
            },
            "market_summary": {
                "total_projects": trends["market_summary"]["total_projects"],
                "top_skill": trends["top_skills"][0] if trends["top_skills"] else None,
                "avg_budget": trends["market_summary"]["avg_budget_overall"]
            },
            "forecast_summary": {
                "next_month": forecast["forecast"][0] if forecast["forecast"] else None,
                "trend": forecast["summary"]["trend"],
                "growth_rate": forecast["summary"]["growth_rate"]
            },
            "generated_at": datetime.utcnow().isoformat()
        }
        
    except Exception as e:
        logger.error(f"Dashboard summary error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to get dashboard summary")


# ============================================================================
# Custom Reports
# ============================================================================

@router.post("/generate-report")
async def generate_custom_report(
    report_type: str = Query(..., description="Type: revenue, users, projects, engagement"),
    start_date: Optional[datetime] = Query(None),
    end_date: Optional[datetime] = Query(None),
    format: str = Query("json", description="Output format: json, csv"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    """
    Generate custom analytics report.
    
    Admin only endpoint.
    """
    if current_user.role != "admin":
        raise HTTPException(status_code=403, detail="Admin access required")
    
    valid_types = ["revenue", "users", "projects", "engagement"]
    if report_type not in valid_types:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid report type. Valid types: {valid_types}"
        )
    
    try:
        service = get_advanced_analytics_service(db)
        
        # Generate report based on type
        if report_type == "revenue":
            data = await service.get_revenue_breakdown(start_date, end_date)
        elif report_type == "users":
            data = await service.get_cohort_analysis()
        elif report_type == "projects":
            data = await service.get_market_trends()
        elif report_type == "engagement":
            data = await service.get_platform_health()
        
        return {
            "report_type": report_type,
            "period": {
                "start": start_date.isoformat() if start_date else None,
                "end": end_date.isoformat() if end_date else None
            },
            "data": data,
            "generated_at": datetime.utcnow().isoformat(),
            "generated_by": current_user.id
        }
        
    except Exception as e:
        logger.error(f"Generate report error: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to generate report")
