# MegiLance Complete App Platform Spec - December 2025
# Frontend (Next.js 14) + Backend (FastAPI) + AI Service + Turso Database
# Domain: megilance.site

name: megilance
region: blr

domains:
  - domain: megilance.site
    type: PRIMARY
    zone: megilance.site
  - domain: www.megilance.site
    type: ALIAS
    zone: megilance.site

ingress:
  rules:
    # Backend API routes
    - component:
        name: backend
        preserve_path_prefix: true
      match:
        path:
          prefix: /api
    # Backend fallback
    - component:
        name: backend
        preserve_path_prefix: true
      match:
        path:
          prefix: /backend
    # AI service routes - internal only, accessed through backend
    # Frontend catches all other routes
    - component:
        name: frontend
      match:
        path:
          prefix: /

services:
  # ============================================
  # BACKEND SERVICE - FastAPI with Turso
  # ============================================
  - name: backend
    github:
      repo: Mwaqarulmulk/MegiLance
      branch: main
      deploy_on_push: true
    dockerfile_path: backend/Dockerfile
    instance_size_slug: basic-s
    instance_count: 1
    http_port: 8000
    
    health_check:
      http_path: /api/health/live
      initial_delay_seconds: 120
      period_seconds: 30
      timeout_seconds: 30
      success_threshold: 1
      failure_threshold: 5
    
    envs:
      # Database - Turso (libSQL) REMOTE ONLY
      - key: TURSO_DATABASE_URL
        value: "libsql://megilance-db-megilance.aws-ap-south-1.turso.io"
        scope: RUN_TIME
      - key: TURSO_AUTH_TOKEN
        scope: RUN_TIME
        type: SECRET
      
      # Security
      - key: SECRET_KEY
        scope: RUN_TIME
        type: SECRET
      - key: ENVIRONMENT
        value: "production"
        scope: RUN_TIME
      
      # CORS - Allow frontend domain
      - key: CORS_ORIGINS
        value: "https://megilance.site,https://www.megilance.site"
        scope: RUN_TIME
      - key: BACKEND_CORS_ORIGINS
        value: '["https://megilance.site","https://www.megilance.site"]'
        scope: RUN_TIME
      
      # Rate limiting
      - key: SLOWAPI_ENABLED
        value: "true"
        scope: RUN_TIME
      
      # AI Service Connection (internal service)
      - key: AI_SERVICE_URL
        value: "${ai-service.PRIVATE_URL}:8001"
        scope: RUN_TIME

  # ============================================
  # AI SERVICE - Advanced ML FastAPI (Internal)
  # ============================================
  - name: ai-service
    github:
      repo: Mwaqarulmulk/MegiLance
      branch: main
      deploy_on_push: true
    dockerfile_path: ai/Dockerfile
    instance_size_slug: basic-s
    instance_count: 1
    http_port: 8001
    
    health_check:
      http_path: /health
      initial_delay_seconds: 180
      period_seconds: 60
      timeout_seconds: 30
      success_threshold: 1
      failure_threshold: 5
      
    envs:
      - key: PORT
        value: "8001"
        scope: RUN_TIME
      - key: ML_WORKERS
        value: "1"
        scope: RUN_TIME
      - key: HF_API_TOKEN
        scope: RUN_TIME
        type: SECRET

  # ============================================
  # FRONTEND SERVICE - Next.js 14
  # ============================================
  - name: frontend
    github:
      repo: Mwaqarulmulk/MegiLance
      branch: main
      deploy_on_push: true
    dockerfile_path: frontend/Dockerfile
    instance_size_slug: basic-xs
    instance_count: 1
    http_port: 3000
    
    health_check:
      http_path: /
      initial_delay_seconds: 90
      period_seconds: 30
      timeout_seconds: 10
      success_threshold: 1
      failure_threshold: 5
    
    envs:
      - key: NODE_ENV
        value: "production"
        scope: RUN_AND_BUILD_TIME
      - key: NEXT_TELEMETRY_DISABLED
        value: "1"
        scope: RUN_AND_BUILD_TIME
      - key: NEXT_PUBLIC_BACKEND_URL
        value: "https://megilance.site"
        scope: RUN_AND_BUILD_TIME
      - key: NEXT_PUBLIC_API_URL
        value: "https://megilance.site/api"
        scope: RUN_AND_BUILD_TIME
