name: Complete AWS Infrastructure Setup

on:
  workflow_dispatch:
    inputs:
      apply:
        description: 'Apply Terraform changes (yes/no)'
        required: true
        default: 'no'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2
  TF_VERSION: 1.5.7

jobs:
  terraform:
    name: Terraform Infrastructure
    runs-on: ubuntu-latest
    outputs:
      rds_endpoint: ${{ steps.output.outputs.rds_endpoint }}
      ecr_backend: ${{ steps.output.outputs.ecr_backend }}
      vpc_id: ${{ steps.output.outputs.vpc_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check OIDC role secret
        env:
          AWS_OIDC_ROLE_ARN: ${{ secrets.AWS_OIDC_ROLE_ARN }}
        run: |
          if [ -z "$AWS_OIDC_ROLE_ARN" ]; then
            echo "ERROR: AWS_OIDC_ROLE_ARN secret is empty or not set."
            echo "Add it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          else
            echo "AWS_OIDC_ROLE_ARN secret is present."
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          role-session-name: github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Debug AWS credentials
        run: |
          echo "Attempting aws sts get-caller-identity..."
          aws sts get-caller-identity || true
          echo "AWS env vars:" && env | grep AWS || true

      - name: Check DB password secret
        env:
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          if [ -z "$TF_VAR_db_password" ]; then
            echo "ERROR: TF_VAR_db_password secret is empty or not set."
            echo "Please add it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          else
            echo "TF_VAR_db_password secret is present."
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: infra/terraform
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
        run: terraform init

      - name: Terraform Format (write)
        working-directory: infra/terraform
        run: terraform fmt -recursive

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: infra/terraform
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: |
          terraform plan -out=tfplan
          terraform show -no-color tfplan > plan.txt

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/plan.txt

      - name: Terraform Apply
        if: github.event.inputs.apply == 'yes'
        working-directory: infra/terraform
        env:
          TF_VAR_aws_region: ${{ env.AWS_REGION }}
          TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        if: github.event.inputs.apply == 'yes'
        id: output
        working-directory: infra/terraform
        run: |
          echo "rds_endpoint=$(terraform output -raw rds_endpoint)" >> $GITHUB_OUTPUT
          echo "ecr_backend=$(terraform output -raw ecr_backend)" >> $GITHUB_OUTPUT
          echo "vpc_id=$(terraform output -raw vpc_id)" >> $GITHUB_OUTPUT
          echo "assets_bucket=$(terraform output -raw assets_bucket)" >> $GITHUB_OUTPUT
          echo "uploads_bucket=$(terraform output -raw uploads_bucket)" >> $GITHUB_OUTPUT

  create-ecs-resources:
    name: Create ECS Cluster and Services
    needs: terraform
    if: github.event.inputs.apply == 'yes'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Export env from secrets
        run: |
          echo "AWS_OIDC_ROLE_ARN=${{ secrets.AWS_OIDC_ROLE_ARN }}" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECS Cluster
        run: |
          aws ecs create-cluster --cluster-name megilance-cluster || echo "Cluster already exists"

      - name: Create CloudWatch Log Group
        run: |
          aws logs create-log-group --log-group-name /ecs/megilance-backend || echo "Log group exists"

      - name: Get Terraform Outputs
        id: tf-outputs
        run: |
          cd infra/terraform
          echo "Getting outputs from Terraform state..."
          # This step would normally pull from terraform state or outputs

  run-migrations:
    name: Run Database Migrations
    needs: [terraform, create-ecs-resources]
    if: github.event.inputs.apply == 'yes'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Export env from secrets
        run: |
          echo "AWS_OIDC_ROLE_ARN=${{ secrets.AWS_OIDC_ROLE_ARN }}" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run Alembic Migrations
        run: |
          echo "Migrations will be run via ECS task once service is deployed"
          # This would be implemented as an ECS run-task command
